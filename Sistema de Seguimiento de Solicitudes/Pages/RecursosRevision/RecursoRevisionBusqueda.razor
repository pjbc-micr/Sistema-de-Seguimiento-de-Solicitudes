@page "/menu/recursos-revision/busqueda"

@using System.Net.Http.Json
@using SolicitudesShared.RecursosRevision
@inject HttpClient Http
@inject IJSRuntime JS

<h3 class="module-header">Búsqueda de Recursos de Revisión</h3>
<p class="module-subtitle">Busque un recurso por folio:</p>

<input class="form-control"
       placeholder="Escriba el folio..."
       value="@FolioBusqueda"
       @oninput="Buscar" />

@if (FolioBusqueda.Length > 0 && Resultados.Count == 0)
{
    <p class="text-muted mt-2">Folio no encontrado...</p>
}

@if (Resultados.Count > 0)
{
    <div class="table-responsive mt-4">
        <table class="table table-bordered table-striped">
            <thead class="table-primary">
                <tr>
                    <th>Fecha Notif. Admisión</th>
                    <th>Respuesta Solicitud</th>
                    <th>Fecha Acuerdo</th>
                    <th>Contenido Acuerdo</th>
                    <th>Materia</th>
                    <th>Razón</th>
                    <th>Sentido Resolución</th>
                    <th>Fecha Notificación</th>
                    <th>Folio</th>
                    <th>Fecha Contestación</th>
                    <th>Fecha Acuerdo Final</th>
                    <th>Contenido Acuerdo Final</th>
                    <th>Acciones</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Resultados)
                {
                    <tr>
                        <td>@Show(item.FechaNotificacionAdmision)</td>
                        <td>@item.RespuestaSolicitud</td>
                        <td>@Show(item.FechaAcuerdo)</td>
                        <td>@item.ContenidoAcuerdo</td>

                        <!-- MATERIA DEL RECURSO (DP / DAI) -->
                        <td>
                            @if (IdEditando == item.IdExpediente)
                            {
                                <select class="form-control" @bind="item.MateriaRecurso">
                                    <option value="">Seleccione...</option>
                                    <option value="DP">DP</option>
                                    <option value="DAI">DAI</option>
                                </select>
                            }
                            else
                            {
                                @item.MateriaRecurso
                            }
                        </td>

                        <td>@item.RazonInterposicion</td>
                        <td>@item.SentidoResolucion</td>
                        <td>@Show(item.FechaNotificacion)</td>
                        <td>@item.FolioSolicitud</td>
                        <td>@Show(item.FechaContestacionRecurso)</td>
                        <td>@Show(item.FechaAcuerdoFinal)</td>
                        <td>@item.ContenidoAcuerdoFinal</td>

                        <td>
                            @if (IdEditando == item.IdExpediente)
                            {
                                <button class="btn btn-success btn-sm"
                                        @onclick="(() => GuardarFila(item))">
                                    Guardar
                                </button>

                                <button class="btn btn-secondary btn-sm ms-2"
                                        @onclick="CancelarEdicion">
                                    Cancelar
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-warning btn-sm"
                                        @onclick="(() => IniciarEdicion(item.IdExpediente))">
                                    Editar
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {

    private string FolioBusqueda = "";
    private List<ExpedienteRevisionDTO> Resultados = new();
    private int? IdEditando = null;

    private async Task Buscar(ChangeEventArgs e)
    {
        FolioBusqueda = e.Value?.ToString() ?? "";

        if (string.IsNullOrWhiteSpace(FolioBusqueda))
        {
            Resultados.Clear();
            IdEditando = null;
            return;
        }

        Resultados = await Http.GetFromJsonAsync<List<ExpedienteRevisionDTO>>(
            $"api/RecursoRevision/Expediente/Buscar?folio={FolioBusqueda}"
        ) ?? new List<ExpedienteRevisionDTO>();
    }

    private string Show(DateTime? dt) =>
        dt?.ToString("yyyy-MM-dd") ?? "--";

    private void IniciarEdicion(int id)
    {
        IdEditando = id;
    }

    private void CancelarEdicion()
    {
        IdEditando = null;
    }

    private async Task GuardarFila(ExpedienteRevisionDTO item)
    {
        bool confirmar = await JS.InvokeAsync<bool>("confirm",
            "¿Deseas guardar los cambios?");

        if (!confirmar)
            return;

        var resp = await Http.PutAsJsonAsync(
            "api/RecursoRevision/Expediente/Actualizar",
            item
        );

        if (resp.IsSuccessStatusCode)
        {
            await JS.InvokeVoidAsync("alert", "Cambios guardados correctamente.");
            IdEditando = null;
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Error al guardar los cambios.");
        }
    }
}
