@page "/menu/recursos-revision/busqueda"

@using System.Net.Http.Json
@using SolicitudesShared.RecursosRevision
@inject HttpClient Http
@inject IJSRuntime JS

<h3 class="module-header">Búsqueda de Expedientes de Revisión</h3>
<p class="module-subtitle">Busque un expediente por folio:</p>

<input class="form-control"
       placeholder="Escriba el folio..."
       @bind="FolioBusqueda"
       @oninput="Buscar" />

@if (FolioBusqueda.Length > 0 && Resultados.Count == 0)
{
    <p class="text-muted mt-2">Folio no encontrado...</p>
}

@if (Resultados.Count > 0)
{
    <div class="table-responsive mt-4">
        <table class="table table-bordered table-striped">
            <thead class="table-primary">
                <tr>
                    <th>Seleccionar</th>
                    <th>Fecha Notif. Admisión</th>
                    <th>Respuesta Solicitud</th>
                    <th>Fecha Acuerdo</th>
                    <th>Contenido Acuerdo</th>
                    <th>Materia</th>
                    <th>Razón</th>
                    <th>Sentido Resolución</th>
                    <th>Fecha Notificación</th>
                    <th>Folio</th>
                    <th>Fecha Contestación</th>
                    <th>Fecha Acuerdo Final</th>
                    <th>Contenido Acuerdo Final</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Resultados)
                {
                    bool esSeleccionado = Resultado.IdExpediente == item.IdExpediente;

                    <tr class="@(esSeleccionado ? "table-warning" : "")">
                        <td>
                            <input type="radio"
                                   name="sel"
                                   @onchange="(() => Seleccionar(item))" />
                        </td>

                        <td>
                            @if (ModoEdicion && esSeleccionado)
                            {
                                <input type="date" class="form-control"
                                       @bind="Resultado.FechaNotificacionAdmision" />
                            }
                            else
                            {

                                @Mostrar(item.FechaNotificacionAdmision)
                            }
                        </td>

                        <td>
                            @if (ModoEdicion && esSeleccionado)
                            {
                                <input class="form-control"
                                       @bind="Resultado.RespuestaSolicitud" />
                            }
                            else
                            {

                                @item.RespuestaSolicitud
                            }
                        </td>

                        <td>
                            @if (ModoEdicion && esSeleccionado)
                            {
                                <input type="date" class="form-control"
                                       @bind="Resultado.FechaAcuerdo" />
                            }
                            else
                            {

                                @Mostrar(item.FechaAcuerdo)
                            }
                        </td>

                        <td>
                            @if (ModoEdicion && esSeleccionado)
                            {
                                <input class="form-control"
                                       @bind="Resultado.ContenidoAcuerdo" />
                            }
                            else
                            {

                                @item.ContenidoAcuerdo
                            }
                        </td>

                        <td>
                            @if (ModoEdicion && esSeleccionado)
                            {
                                <input class="form-control"
                                       @bind="Resultado.MateriaRecurso" />
                            }
                            else
                            {

                                @item.MateriaRecurso
                            }
                        </td>

                        <td>
                            @if (ModoEdicion && esSeleccionado)
                            {
                                <input class="form-control"
                                       @bind="Resultado.RazonInterposicion" />
                            }
                            else
                            {

                                @item.RazonInterposicion
                            }
                        </td>

                        <td>
                            @if (ModoEdicion && esSeleccionado)
                            {
                                <input class="form-control"
                                       @bind="Resultado.SentidoResolucion" />
                            }
                            else
                            {

                                @item.SentidoResolucion
                            }
                        </td>

                        <td>
                            @if (ModoEdicion && esSeleccionado)
                            {
                                <input type="date" class="form-control"
                                       @bind="Resultado.FechaNotificacion" />
                            }
                            else
                            {

                                @Mostrar(item.FechaNotificacion)
                            }
                        </td>

                        <td>
                            @if (ModoEdicion && esSeleccionado)
                            {
                                <input class="form-control"
                                       @bind="Resultado.FolioSolicitud" />
                            }
                            else
                            {

                                @item.FolioSolicitud
                            }
                        </td>

                        <td>
                            @if (ModoEdicion && esSeleccionado)
                            {
                                <input type="date" class="form-control"
                                       @bind="Resultado.FechaContestacionRecurso" />
                            }
                            else
                            {

                                @Mostrar(item.FechaContestacionRecurso)
                            }
                        </td>

                        <td>
                            @if (ModoEdicion && esSeleccionado)
                            {
                                <input type="date" class="form-control"
                                       @bind="Resultado.FechaAcuerdoFinal" />
                            }
                            else
                            {

                                @Mostrar(item.FechaAcuerdoFinal)
                            }
                        </td>

                        <td>
                            @if (ModoEdicion && esSeleccionado)
                            {
                                <input class="form-control"
                                       @bind="Resultado.ContenidoAcuerdoFinal" />
                            }
                            else
                            {

                                @item.ContenidoAcuerdoFinal
                            }
                        </td>
                    </tr>
                }
            </tbody>

        </table>
    </div>

    <button class="btn btn-warning mt-3 me-2" @onclick="ActivarEdicion" disabled="@(!PuedeEditar)">
        ✏ Editar
    </button>

    @if (ModoEdicion)
    {
        <button class="btn btn-success mt-3" @onclick="GuardarCambios">
            💾 Guardar
        </button>

        <h4 class="mt-4">Editar Expediente Seleccionado</h4>

        <div class="row">
            <div class="col-md-4">
                <label>Fecha Notificación Admisión:</label>
                <input type="date" class="form-control" @bind="Resultado.FechaNotificacionAdmision" />
            </div>

            <div class="col-md-4">
                <label>Respuesta Solicitud:</label>
                <input class="form-control" @bind="Resultado.RespuestaSolicitud" />
            </div>

            <div class="col-md-4">
                <label>Fecha Acuerdo:</label>
                <input type="date" class="form-control" @bind="Resultado.FechaAcuerdo" />
            </div>

            <div class="col-md-4">
                <label>Contenido Acuerdo:</label>
                <input class="form-control" @bind="Resultado.ContenidoAcuerdo" />
            </div>

            <div class="col-md-4">
                <label>Materia:</label>
                <input class="form-control" @bind="Resultado.MateriaRecurso" />
            </div>

            <div class="col-md-4">
                <label>Razón Interposición:</label>
                <input class="form-control" @bind="Resultado.RazonInterposicion" />
            </div>

            <div class="col-md-4">
                <label>Sentido Resolución:</label>
                <input class="form-control" @bind="Resultado.SentidoResolucion" />
            </div>

            <div class="col-md-4">
                <label>Fecha Notificación:</label>
                <input type="date" class="form-control" @bind="Resultado.FechaNotificacion" />
            </div>

            <div class="col-md-4">
                <label>Folio:</label>
                <input class="form-control" @bind="Resultado.FolioSolicitud" />
            </div>

            <div class="col-md-4">
                <label>Fecha Contestación:</label>
                <input type="date" class="form-control" @bind="Resultado.FechaContestacionRecurso" />
            </div>

            <div class="col-md-4">
                <label>Fecha Acuerdo Final:</label>
                <input type="date" class="form-control" @bind="Resultado.FechaAcuerdoFinal" />
            </div>

            <div class="col-md-4">
                <label>Contenido Acuerdo Final:</label>
                <input class="form-control" @bind="Resultado.ContenidoAcuerdoFinal" />
            </div>
        </div>
    }
}

@code {
    private string FolioBusqueda = "";
    private List<ExpedienteRevisionDTO> Resultados = new();
    private ExpedienteRevisionDTO Resultado = new();
    private bool ModoEdicion = false;

    private bool PuedeEditar => Resultado.IdExpediente > 0;

    private async Task Buscar(ChangeEventArgs e)
    {
        FolioBusqueda = e.Value?.ToString() ?? "";

        if (string.IsNullOrWhiteSpace(FolioBusqueda))
        {
            Resultados.Clear();
            Resultado = new();
            ModoEdicion = false;
            return;
        }

        Resultados =
            await Http.GetFromJsonAsync<List<ExpedienteRevisionDTO>>(
                $"api/RecursoRevision/Expediente/Buscar?folio={FolioBusqueda}"
            ) ?? new List<ExpedienteRevisionDTO>();
    }

    private string Mostrar(DateTime? dt) => dt?.ToString("dd/MM/yyyy") ?? "--";

    private void Seleccionar(ExpedienteRevisionDTO item)
    {
        Resultado = item;
        ModoEdicion = false;
    }

    private void ActivarEdicion()
    {
        if (Resultado.IdExpediente > 0)
            ModoEdicion = true;
    }

    private async Task GuardarCambios()
    {
        bool confirmar = await JS.InvokeAsync<bool>("confirm", "¿Deseas guardar los cambios?");

        if (!confirmar)
            return;

        var resp = await Http.PutAsJsonAsync("api/RecursoRevision/Expediente/Actualizar", Resultado);

        if (resp.IsSuccessStatusCode)
        {
            await JS.InvokeVoidAsync("alert", "Cambios guardados.");
            ModoEdicion = false;
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Error al guardar.");
        }
    }
}
