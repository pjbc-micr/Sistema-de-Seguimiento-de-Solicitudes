@page "/menu/recursos-revision/busqueda"

@using System.Net.Http.Json
@using SolicitudesShared.RecursosRevision
@inject HttpClient Http
@inject IJSRuntime JS

<h3 class="module-header">Búsqueda de Expedientes</h3>
<p class="module-subtitle">Escriba el folio o número de recurso para buscar:</p>

<input class="form-control"
       placeholder="Escriba el folio o número de recurso..."
       @bind="FolioBusqueda"
       @oninput="Buscar" />

@if (Resultados.Count == 0 && FolioBusqueda.Length > 0)
{
    <p class="text-muted mt-2">No se encontraron expedientes…</p>
}

@if (Resultados.Count > 0)
{
    <div class="table-responsive mt-3">
        <table class="table table-bordered table-striped">
            <thead class="table-primary">
                <tr>
                    <th>Editar</th>
                    <th>Núm. Recurso</th>
                    <th>Estatus</th>
                    <th>Res. Sentido</th>
                    <th>Contenido Solicitud</th>
                    <th>Nombre Recurrente</th>
                    <th>Sentido Contestación</th>
                    <th>Fecha Notif. Adm.</th>
                    <th>Respuesta</th>
                    <th>Fecha Acuerdo</th>
                    <th>Contenido Acuerdo</th>
                    <th>Materia</th>
                    <th>Razón</th>
                    <th>Fecha Notif.</th>
                    <th>Folio</th>
                    <th>Fecha Contestación</th>
                    <th>Fecha Acuerdo Final</th>
                    <th>Contenido Acuerdo Final</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var row in Resultados)
                {
                    <tr>
                        <td>
                            <button class="btn btn-warning btn-sm"
                                    @onclick="@(() => row.IsEditing = !row.IsEditing)">
                                @((row.IsEditing ? "Cancel" : "Editar"))
                            </button>

                            @if (row.IsEditing)
                            {
                                <button class="btn btn-success btn-sm ms-2"
                                        @onclick="@(() => Guardar(row))">
                                    Guardar
                                </button>
                            }
                        </td>

                        @Cell(row, nameof(row.NumeroRecurso))
                        @Cell(row, nameof(row.Estatus))
                        @Cell(row, nameof(row.ResolucionSentido))
                        @Cell(row, nameof(row.ContenidoSolicitud))
                        @Cell(row, nameof(row.NombreRecurrente))
                        @Cell(row, nameof(row.SentidoContestacion))
                        @Cell(row, nameof(row.FechaNotificacionAdmision), true)
                        @Cell(row, nameof(row.RespuestaSolicitud))
                        @Cell(row, nameof(row.FechaAcuerdo), true)
                        @Cell(row, nameof(row.ContenidoAcuerdo))

                        @* MATERIA — ListBox *@
                        <td>
                            @if (row.IsEditing)
                            {
                                <select class="form-select form-select-sm"
                                        @bind="row.MateriaRecurso">
                                    <option value="">--</option>
                                    <option>DAI</option>
                                    <option>DP</option>
                                </select>
                            }
                            else
                            {
                                @row.MateriaRecurso
                            }
                        </td>

                        @Cell(row, nameof(row.RazonInterposicion))
                        @Cell(row, nameof(row.FechaNotificacion), true)
                        @Cell(row, nameof(row.FolioSolicitud))
                        @Cell(row, nameof(row.FechaContestacionRecurso), true)
                        @Cell(row, nameof(row.FechaAcuerdoFinal), true)
                        @Cell(row, nameof(row.ContenidoAcuerdoFinal))
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {

    private string FolioBusqueda = "";
    private List<ExpedienteRevisionDTO> Resultados = new();

    // OPCIONES PARA LISTBOXES
    private readonly string[] OpcionesEstatus = new[]
    {
        "En trámite",
        "Concluido"
    };

    private readonly string[] OpcionesResolucionSentido = new[]
    {
        "Confirma",
        "Sobresee",
        "Modifica",
        "Revoca",
        "Dar Respuesta"
    };
    // FIN OPCIONES LISTBOXES

    private async Task Buscar(ChangeEventArgs e)
    {
        FolioBusqueda = e.Value?.ToString() ?? "";

        if (string.IsNullOrWhiteSpace(FolioBusqueda))
        {
            Resultados.Clear();
            return;
        }

        // La llamada a la API permanece igual, pero la API buscará en dos campos.
        Resultados =
            await Http.GetFromJsonAsync<List<ExpedienteRevisionDTO>>(
                $"api/RecursoRevision/Expediente/Buscar?folio={FolioBusqueda}"
            ) ?? new();
    }

    private async Task Guardar(ExpedienteRevisionDTO row)
    {
        var resp = await Http.PutAsJsonAsync("api/RecursoRevision/Expediente/Actualizar", row);

        if (resp.IsSuccessStatusCode)
        {
            row.IsEditing = false;
            await JS.InvokeVoidAsync("alert", "Cambios guardados.");
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Error al guardar cambios.");
        }
    }

    RenderFragment Cell(ExpedienteRevisionDTO row, string prop, bool isDate = false) => builder =>
    {
        builder.OpenElement(0, "td");

        var valor = row.GetType().GetProperty(prop)?.GetValue(row);

        // Identificadores de campo para Listbox
        var isResolucionSentido = prop == nameof(ExpedienteRevisionDTO.ResolucionSentido);
        var isEstatus = prop == nameof(ExpedienteRevisionDTO.Estatus);

        // Determinar qué opciones usar (si aplica)
        string[] opcionesListbox = null;
        if (isResolucionSentido)
            opcionesListbox = OpcionesResolucionSentido;
        else if (isEstatus)
            opcionesListbox = OpcionesEstatus;


        if (row.IsEditing)
        {
            if (isDate)
            {
                // CAMPO DE FECHA
                builder.OpenElement(1, "input");
                builder.AddAttribute(2, "type", "date");
                builder.AddAttribute(3, "class", "form-control form-control-sm");
                builder.AddAttribute(4, "value", valor is DateTime dt ? dt.ToString("yyyy-MM-dd") : "");
                builder.AddAttribute(5, "onchange",
                    EventCallback.Factory.Create<ChangeEventArgs>(this, e =>
                    {
                        if (DateTime.TryParse(e.Value?.ToString(), out var parsed))
                            row.GetType().GetProperty(prop)?.SetValue(row, parsed);
                        else
                            row.GetType().GetProperty(prop)?.SetValue(row, null);
                    }));
                builder.CloseElement();
            }
            else if (opcionesListbox != null)
            {
                // CAMPO LISTBOX (Estatus o Resolución Sentido)
                builder.OpenElement(1, "select");
                builder.AddAttribute(2, "class", "form-select form-select-sm");
                builder.AddAttribute(3, "onchange",
                    EventCallback.Factory.Create<ChangeEventArgs>(this, e =>
                    {
                        row.GetType().GetProperty(prop)?.SetValue(row, e.Value?.ToString());
                    }));

                // Opción por defecto
                builder.OpenElement(4, "option");
                builder.AddAttribute(5, "value", "");
                builder.AddContent(6, "--Seleccione--");
                builder.CloseElement();

                // Opciones del Listbox
                int seq = 7;
                foreach (var opcion in opcionesListbox)
                {
                    builder.OpenElement(seq++, "option");
                    builder.AddAttribute(seq++, "value", opcion);

                    // Marca la opción seleccionada
                    if (opcion == valor?.ToString())
                    {
                        builder.AddAttribute(seq++, "selected", true);
                    }

                    builder.AddContent(seq++, opcion);
                    builder.CloseElement();
                }

                builder.CloseElement(); // Cierra el select
            }
            else
            {
                // CAMPO DE TEXTO SIMPLE (Por defecto)
                builder.OpenElement(1, "input");
                builder.AddAttribute(2, "class", "form-control form-control-sm");
                builder.AddAttribute(3, "value", valor?.ToString() ?? "");
                builder.AddAttribute(4, "onchange",
                    EventCallback.Factory.Create<ChangeEventArgs>(this, e =>
                    {
                        row.GetType().GetProperty(prop)?.SetValue(row, e.Value?.ToString());
                    }));
                builder.CloseElement();
            }
        }
        else
        {
            // MODO DE VISUALIZACIÓN
            if (isDate && valor is DateTime dt)
                builder.AddContent(6, dt.ToString("dd/MM/yyyy"));
            else
                builder.AddContent(6, valor?.ToString() ?? "--");
        }

        builder.CloseElement();
    };
}