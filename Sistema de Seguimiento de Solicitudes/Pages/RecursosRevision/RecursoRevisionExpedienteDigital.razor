@page "/menu/recursos-revision/registro/expediente"

@using System.Net.Http.Json
@using SolicitudesShared.RecursosRevision
@inject NavigationManager Navigation
@inject HttpClient Http
@inject IJSRuntime JS

<h3 class="module-header">Expediente Digital del Recurso de Revisión</h3>
<p class="module-subtitle">Capture la información correspondiente:</p>

<div class="table-responsive mt-4">
    <table class="table table-bordered table-striped">
        <thead class="table-primary">
            <tr>
                <th>Número de Recurso</th>
                <th>Estatus</th>
                <th>Resolución en Sentido</th>
                <th>Contenido Solicitud</th>
                <th>Nombre Recurrente</th>
                <th>Sentido Contestación</th>
                <th>Fecha Notificación Admisión</th>
                <th>Respuesta Solicitud</th>
                <th>Fecha Acuerdo</th>
                <th>Contenido Acuerdo</th>
                <th>Materia</th>
                <th>Razón</th>
                <th>Fecha Notificación</th>
                <th>Folio</th>
                <th>Fecha Contestación</th>
                <th>Fecha Acuerdo Final</th>
                <th>Contenido Acuerdo Final</th>
            </tr>
        </thead>

        <tbody>
            <tr>
                <td><input class="form-control" @bind="Modelo.NumeroRecurso" /></td>

                <td>
                    <select class="form-select" @bind="Modelo.Estatus">
                        <option value="">--Seleccione--</option>
                        <option>En trámite</option>
                        <option>Concluido</option>
                    </select>
                </td>

                <td>
                    <select class="form-select" @bind="Modelo.ResolucionSentido">
                        <option value="">--Seleccione--</option>
                        <option>Confirma</option>
                        <option>Sobresee</option>
                        <option>Modifica</option>
                        <option>Revoca</option>
                        <option>Dar Respuesta</option>
                    </select>
                </td>

                <td><input class="form-control" @bind="Modelo.ContenidoSolicitud" /></td>
                <td><input class="form-control" @bind="Modelo.NombreRecurrente" /></td>
                <td><input class="form-control" @bind="Modelo.SentidoContestacion" /></td>

                <td><input type="date" class="form-control" @bind="Modelo.FechaNotificacionAdmision" /></td>
                <td><input class="form-control" @bind="Modelo.RespuestaSolicitud" /></td>
                <td><input type="date" class="form-control" @bind="Modelo.FechaAcuerdo" /></td>
                <td><input class="form-control" @bind="Modelo.ContenidoAcuerdo" /></td>

                <td>
                    <select class="form-select" @bind="Modelo.MateriaRecurso">
                        <option value="">--Seleccione--</option>
                        <option>DAI</option>
                        <option>DP</option>
                    </select>
                </td>

                <td><input class="form-control" @bind="Modelo.RazonInterposicion" /></td>
                <td><input type="date" class="form-control" @bind="Modelo.FechaNotificacion" /></td>
                <td><input class="form-control" @bind="Modelo.FolioSolicitud" /></td>
                <td><input type="date" class="form-control" @bind="Modelo.FechaContestacionRecurso" /></td>
                <td><input type="date" class="form-control" @bind="Modelo.FechaAcuerdoFinal" /></td>
                <td><input class="form-control" @bind="Modelo.ContenidoAcuerdoFinal" /></td>
            </tr>
        </tbody>
    </table>
</div>

<button class="btn btn-primary mt-3 me-2" @onclick="Guardar">Guardar</button>

<button class="btn btn-danger mt-3" @onclick="GenerarPDF">
    <i class="bi bi-filetype-pdf"></i> Descargar PDF
</button>

@code {

    private ExpedienteRevisionDTO Modelo = new ExpedienteRevisionDTO();

    private async Task Guardar()
    {
        var resp = await Http.PostAsJsonAsync("api/RecursoRevision/Expediente", Modelo);

        if (resp.IsSuccessStatusCode)
        {
            bool generar = await JS.InvokeAsync<bool>("confirm",
                "Expediente guardado correctamente.\n\n¿Desea generar PDF?");

            if (generar)
                await GenerarPDF();
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Error al guardar.");
        }
    }

    private async Task GenerarPDF()
    {
        var resp = await Http.PostAsJsonAsync("api/RecursoRevision/Expediente/PDF", Modelo);

        if (resp.IsSuccessStatusCode)
        {
            var pdf = await resp.Content.ReadAsByteArrayAsync();

            await JS.InvokeVoidAsync("downloadFileFromByteArray", new
            {
                ByteArray = pdf,
                FileName = "ExpedienteRevision.pdf",
                ContentType = "application/pdf"
            });
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Error al generar PDF.");
        }
    }
}
