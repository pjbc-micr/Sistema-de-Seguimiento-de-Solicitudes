@page "/menu/recursos-revision/registro/expediente"

@using System.Net.Http.Json
@using SolicitudesShared.RecursosRevision
@inject NavigationManager Navigation
@inject HttpClient Http
@inject IJSRuntime JS

<h3 class="module-header">Expediente Digital del Recurso de Revisión</h3>
<p class="module-subtitle">Capture la información correspondiente:</p>

<div class="table-responsive mt-4">
    <table class="table table-bordered table-striped">
        <thead class="table-primary">
            <tr>
                <th>Número de Recurso</th>
                <th>Estatus</th>
                <th>Resolución en Sentido</th>
                <th>Contenido Solicitud</th>
                <th>Nombre Recurrente</th>
                <th>Sentido Contestación</th>
                <th>Fecha Notificación Admisión</th>
                <th>Respuesta Solicitud</th>
                <th>Fecha Acuerdo</th>
                <th>Contenido Acuerdo</th>
                <th>Materia</th>
                <th>Razón</th>
                <th>Fecha Notificación</th>
                <th>Folio</th>
                <th>Fecha Contestación</th>
                <th>Fecha Acuerdo Final</th>
                <th>Contenido Acuerdo Final</th>
            </tr>
        </thead>

        <tbody>
            <tr>
                <td><input class="form-control" @bind="Modelo.NumeroRecurso" /></td>

                <td>
                    <select class="form-select" @bind="Modelo.Estatus">
                        <option value="">--Seleccione--</option>
                        <option>En trámite</option>
                        <option>Concluido</option>
                    </select>
                </td>

                <td>
                    <select class="form-select" @bind="Modelo.ResolucionSentido">
                        <option value="">--Seleccione--</option>
                        <option>Confirma</option>
                        <option>Sobresee</option>
                        <option>Modifica</option>
                        <option>Revoca</option>
                        <option>Dar Respuesta</option>
                    </select>
                </td>

                <td><input class="form-control" @bind="Modelo.ContenidoSolicitud" /></td>
                <td><input class="form-control" @bind="Modelo.NombreRecurrente" /></td>
                <td><input class="form-control" @bind="Modelo.SentidoContestacion" /></td>

                <td><input type="date" class="form-control" @bind="Modelo.FechaNotificacionAdmision" /></td>
                <td><input class="form-control" @bind="Modelo.RespuestaSolicitud" /></td>
                <td><input type="date" class="form-control" @bind="Modelo.FechaAcuerdo" /></td>
                <td><input class="form-control" @bind="Modelo.ContenidoAcuerdo" /></td>

                <td>
                    <select class="form-select" @bind="Modelo.MateriaRecurso">
                        <option value="">--Seleccione--</option>
                        <option>DAI</option>
                        <option>DP</option>
                    </select>
                </td>

                <td><input class="form-control" @bind="Modelo.RazonInterposicion" /></td>
                <td><input type="date" class="form-control" @bind="Modelo.FechaNotificacion" /></td>
                <td><input class="form-control" @bind="Modelo.FolioSolicitud" /></td>
                <td><input type="date" class="form-control" @bind="Modelo.FechaContestacionRecurso" /></td>
                <td><input type="date" class="form-control" @bind="Modelo.FechaAcuerdoFinal" /></td>
                <td><input class="form-control" @bind="Modelo.ContenidoAcuerdoFinal" /></td>
            </tr>
        </tbody>
    </table>
</div>

<button class="btn btn-primary mt-3 me-2" @onclick="Guardar">Guardar</button>

<button class="btn btn-danger mt-3" @onclick="GenerarPDF">
    <i class="bi bi-filetype-pdf"></i> Descargar PDF
</button>

<button class="btn btn-info ms-2" @onclick="() => MostrarPanelPDF = true">
    Agregar PDF
</button>

<button class="btn btn-secondary ms-2" @onclick="MostrarDocumentosGuardados">
    Documentos Guardados
</button>

<!-- PANEL PARA AGREGAR PDF -->
@if (MostrarPanelPDF)
{
    <div class="card p-3 mt-3 border-info">
        <h5>Agregar PDF al expediente</h5>

        <InputFile OnChange="OnFileSelected" accept="application/pdf" />

        @if (!string.IsNullOrEmpty(NombreArchivo))
        {
            <p class="mt-2 text-muted">Archivo seleccionado: <b>@NombreArchivo</b></p>
        }

        <button class="btn btn-success mt-2" @onclick="GuardarPDF">Guardar</button>
        <button class="btn btn-secondary mt-2 ms-2" @onclick="() => MostrarPanelPDF = false">Cancelar</button>
    </div>
}

<!-- PANEL DOCUMENTOS GUARDADOS -->
@if (MostrarListaDocumentos)
{
    <div class="card p-3 mt-3 border-secondary">
        <h5>Documentos Guardados</h5>

        @if (ListaPDFs.Count == 0)
        {
            <p class="text-muted">No hay documentos guardados.</p>
        }
        else
        {
            <table class="table table-bordered mt-2">
                <thead class="table-secondary">
                    <tr>
                        <th>Nombre</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var pdf in ListaPDFs)
                    {
                        <tr>
                            <td>@pdf.NombreArchivo</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary"
                                        @onclick="() => DescargarPDF(pdf.IdArchivo)">
                                    Descargar
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }

        <button class="btn btn-outline-secondary mt-2"
                @onclick="() => MostrarListaDocumentos = false">
            Cerrar
        </button>
    </div>
}

@code {

    private ExpedienteRevisionDTO Modelo = new ExpedienteRevisionDTO();

    // ===============================================================
    // GUARDAR EXPEDIENTE
    // ===============================================================
    private async Task Guardar()
    {
        var resp = await Http.PostAsJsonAsync("api/RecursoRevision/Expediente", Modelo);

        if (resp.IsSuccessStatusCode)
        {
            var json = await resp.Content.ReadFromJsonAsync<CreacionExpedienteDTO>();
            Modelo.IdExpediente = json?.IdExpedienteCreado ?? 0;

            if (await JS.InvokeAsync<bool>("confirm",
                "Expediente guardado correctamente.\n\n¿Desea generar PDF?"))
            {
                await GenerarPDF();
            }
        }
        else
            await JS.InvokeVoidAsync("alert", "Error al guardar.");
    }

    // ===============================================================
    // GENERAR PDF (EXPEDIENTE)
    // ===============================================================
    private async Task GenerarPDF()
    {
        var resp = await Http.PostAsJsonAsync("api/RecursoRevision/Expediente/PDF", Modelo);

        if (resp.IsSuccessStatusCode)
        {
            var pdf = await resp.Content.ReadAsByteArrayAsync();

            await JS.InvokeVoidAsync("downloadFileFromByteArray", new
            {
                ByteArray = pdf,
                FileName = "ExpedienteRevision.pdf",
                ContentType = "application/pdf"
            });
        }
        else
            await JS.InvokeVoidAsync("alert", "Error al generar PDF.");
    }

    // ===============================================================
    // SUBIR PDF (INDEPENDIENTE DEL EXPEDIENTE)
    // ===============================================================

    private bool MostrarPanelPDF = false;
    private IBrowserFile? ArchivoSeleccionado;
    private string NombreArchivo = "";

    public class ArchivoPDFDTO
    {
        public int IdArchivo { get; set; }
        public string NombreArchivo { get; set; } = "";
    }

    private List<ArchivoPDFDTO> ListaPDFs = new();

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        ArchivoSeleccionado = e.File;
        NombreArchivo = e.File.Name;
    }

    private async Task GuardarPDF()
    {
        if (ArchivoSeleccionado == null)
        {
            await JS.InvokeVoidAsync("alert", "Selecciona un PDF primero.");
            return;
        }

        // Crear expediente vacío si no existe
        if (Modelo.IdExpediente == 0)
        {
            var resp = await Http.PostAsJsonAsync("api/RecursoRevision/Expediente/CrearVacio", new { });
            var json = await resp.Content.ReadFromJsonAsync<CreacionExpedienteDTO>();
            Modelo.IdExpediente = json!.IdExpedienteCreado;
        }

        var content = new MultipartFormDataContent();
        var stream = ArchivoSeleccionado.OpenReadStream(long.MaxValue);

        content.Add(new StreamContent(stream), "archivo", ArchivoSeleccionado.Name);
        content.Add(new StringContent(Modelo.IdExpediente.ToString()), "idExpediente");

        var resp2 = await Http.PostAsync("api/RecursoRevision/Expediente/SubirPDF", content);

        if (resp2.IsSuccessStatusCode)
        {
            await JS.InvokeVoidAsync("alert", "PDF guardado correctamente.");
            MostrarPanelPDF = false;
            await CargarTodosLosPDFs();
        }
        else
            await JS.InvokeVoidAsync("alert", "Error al guardar PDF.");
    }

    // ===============================================================
    // LISTAR TODOS LOS PDFs DE LA BD
    // ===============================================================
    private bool MostrarListaDocumentos = false;

    private async Task MostrarDocumentosGuardados()
    {
        MostrarListaDocumentos = true;
        await CargarTodosLosPDFs();
    }

    private async Task CargarTodosLosPDFs()
    {
        ListaPDFs =
            await Http.GetFromJsonAsync<List<ArchivoPDFDTO>>("api/RecursoRevision/Expediente/PDFs/Todos")
            ?? new();
    }

    // ===============================================================
    // DESCARGAR PDF INDIVIDUAL
    // ===============================================================
    private async Task DescargarPDF(int idArchivo)
    {
        var resp = await Http.GetAsync($"api/RecursoRevision/Expediente/PDF/{idArchivo}");

        if (!resp.IsSuccessStatusCode)
        {
            await JS.InvokeVoidAsync("alert", "Error al descargar PDF.");
            return;
        }

        // EXTRAER NOMBRE REAL DEL ARCHIVO DESDE LOS HEADERS HTTP
        var contentDisposition = resp.Content.Headers.ContentDisposition;
        string nombreReal = contentDisposition?.FileNameStar ?? contentDisposition?.FileName ?? $"archivo_{idArchivo}.pdf";

        var bytes = await resp.Content.ReadAsByteArrayAsync();

        await JS.InvokeVoidAsync("downloadFileFromByteArray", new
        {
            ByteArray = bytes,
            FileName = nombreReal,   // 👈 USAR EL NOMBRE REAL
            ContentType = "application/pdf"
        });
    }

}
