@page "/menu/recursos-revision/registro/expediente"

@using System.Net.Http.Json
@using SolicitudesShared.RecursosRevision
@inject NavigationManager Navigation
@inject HttpClient Http
@inject IJSRuntime JS

<h3 class="module-header">Expediente Digital del Recurso de Revisión</h3>
<p class="module-subtitle">Capture la información correspondiente:</p>

<div class="table-responsive mt-4">
    <table class="table table-bordered table-striped">
        <thead class="table-primary">
            <tr>
                <th>Fecha de Notificación de Admisión</th>
                <th>Respuesta de la Solicitud</th>
                <th>Fecha de Acuerdo</th>
                <th>Contenido del Acuerdo</th>
                <th>Materia del Recurso</th>
                <th>Razón de la Interposición</th>
                <th>Sentido de la Resolución</th>
                <th>Fecha de Notificación</th>
                <th>Folio de la Solicitud</th>
                <th>Fecha de Contestación del Recurso</th>
                <th>Fecha de Acuerdo Final</th>
                <th>Contenido del Acuerdo Final</th>
            </tr>
        </thead>

        <tbody>
            <tr>
                <td><input type="date" class="form-control" @bind="Modelo.FechaNotificacionAdmision" /></td>
                <td><input class="form-control" @bind="Modelo.RespuestaSolicitud" /></td>
                <td><input type="date" class="form-control" @bind="Modelo.FechaAcuerdo" /></td>
                <td><input class="form-control" @bind="Modelo.ContenidoAcuerdo" /></td>
                <select class="form-control" @bind="Modelo.MateriaRecurso">
                    <option value="">Seleccione una opción...</option>
                    <option value="DP">DP</option>
                    <option value="DAI">DAI</option>
                </select>
                <td><input class="form-control" @bind="Modelo.RazonInterposicion" /></td>
                <td><input class="form-control" @bind="Modelo.SentidoResolucion" /></td>
                <td><input type="date" class="form-control" @bind="Modelo.FechaNotificacion" /></td>
                <td><input class="form-control" @bind="Modelo.FolioSolicitud" /></td>
                <td><input type="date" class="form-control" @bind="Modelo.FechaContestacionRecurso" /></td>

                <!-- ✔ NUEVO CAMPO -->
                <td><input type="date" class="form-control" @bind="Modelo.FechaAcuerdoFinal" /></td>

                <!-- ✔ SIGUE IGUAL -->
                <td><input class="form-control" @bind="Modelo.ContenidoAcuerdoFinal" /></td>
            </tr>
        </tbody>
    </table>
</div>

<button class="btn btn-primary mt-3 me-2" @onclick="Guardar">Guardar</button>
<button class="btn btn-danger mt-3" @onclick="GenerarPDF">
    <i class="bi bi-filetype-pdf"></i> Descargar PDF
</button>

@code {

    private ExpedienteRevisionDTO Modelo = new ExpedienteRevisionDTO();

    private async Task Guardar()
    {
        var respuesta = await Http.PostAsJsonAsync("api/RecursoRevision/Expediente", Modelo);

        if (respuesta.IsSuccessStatusCode)
        {
            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Expediente guardado correctamente.\n\n¿Deseas generar el PDF ahora?");

            if (confirmar)
            {
                await GenerarPDF();
            }
        }
        else
        {
            var error = await respuesta.Content.ReadAsStringAsync();
            await JS.InvokeVoidAsync("alert", "Error al guardar: " + error);
        }
    }

    private async Task GenerarPDF()
    {
        try
        {
            var resp = await Http.PostAsJsonAsync("api/RecursoRevision/Expediente/PDF", Modelo);

            if (resp.IsSuccessStatusCode)
            {
                var pdfBytes = await resp.Content.ReadAsByteArrayAsync();

                await JS.InvokeVoidAsync("downloadFileFromByteArray", new
                {
                    ByteArray = pdfBytes,
                    FileName = "ExpedienteRevision.pdf",
                    ContentType = "application/pdf"
                });
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Error al generar el PDF.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", ex.Message);
        }
    }

}
